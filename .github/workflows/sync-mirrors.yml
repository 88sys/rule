name: Sync Mirror Repositories

on:
  schedule:
    # ä¿®æ­£ï¼šåŒ—äº¬æ—¶é—´ 07:20 (UTC 23:20) å’Œ 19:20 (UTC 11:20)
    - cron: '20 11,23 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œæ²¡æœ‰é¢å¤–é€‰é¡¹

# ä¼˜åŒ–ï¼šæŽ’é˜Ÿè€Œä¸æ˜¯æ€æŽ‰æ­£åœ¨è¿›è¡Œçš„åŒæ­¥ï¼Œé˜²æ­¢ git push è¢«ä¸­æ–­
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# å®‰å…¨ï¼šæœ€å°åŒ– GITHUB_TOKEN æƒé™
permissions:
  contents: read

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 1. æ˜¾ç¤ºè¿è¡Œä¿¡æ¯
        run: |
          echo "=== é•œåƒåŒæ­¥ä»»åŠ¡å¯åŠ¨ ==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "UTCæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "åŒ—äº¬æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S' -d '+8 hours')"

      - name: 2. è®¾ç½®SSHå¯†é’¥å¯¹
        run: |
          echo "é…ç½®SSHçŽ¯å¢ƒ..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # å†™å…¥ä¸¤ä¸ªç‹¬ç«‹çš„ç§é’¥ï¼ˆä½¿ç”¨å…¨åè§„åˆ™ï¼‰
          echo "${{ secrets.SSH_PRIVATE_KEY_TIMEFLYSOON }}" > ~/.ssh/id_ed25519_timeflysoon
          echo "${{ secrets.SSH_PRIVATE_KEY_88ALT }}" > ~/.ssh/id_ed25519_88alt
          chmod 600 ~/.ssh/id_ed25519_timeflysoon ~/.ssh/id_ed25519_88alt
          
          # é…ç½®SSHä¸»æœºåˆ«åï¼ˆä½¿ç”¨å…¨åè§„åˆ™ï¼‰
          cat > ~/.ssh/config << 'EOF'
          Host github-timeflysoon
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519_timeflysoon
            IdentitiesOnly yes
            StrictHostKeyChecking no
          
          Host github-88alt
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519_88alt
            IdentitiesOnly yes
            StrictHostKeyChecking no
          EOF
          
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          
          echo "âœ… SSHé…ç½®å®Œæˆ"
          echo "å·²ä½¿ç”¨å…¨åè§„åˆ™ï¼š"
          echo "  - github-timeflysoon -> id_ed25519_timeflysoon"
          echo "  - github-88alt -> id_ed25519_88alt"

      - name: 3. éªŒè¯SSHè¿žæŽ¥
        shell: bash
        run: |
          echo "éªŒè¯SSHå¯†é’¥è¿žæŽ¥..."
          
          EXIT_CODE=0
          
          # å…³é”®ä¿®å¤ï¼šä½¿ç”¨ (ssh || true) é¿å… SSH çš„é€€å‡ºç  1 å¯¼è‡´ç®¡é“å¤±è´¥
          echo "æµ‹è¯• timeflysoon ä»“åº“è¿žæŽ¥..."
          if (ssh -T git@github-timeflysoon 2>&1 || true) | grep -q "timeflysoon"; then
            echo "âœ… å¯†é’¥ timeflysoon è¿žæŽ¥æˆåŠŸ"
          else
            echo "âŒ å¯†é’¥ timeflysoon è¿žæŽ¥å¤±è´¥"
            EXIT_CODE=1
          fi
          
          # æµ‹è¯•ç¬¬äºŒä¸ªå¯†é’¥
          echo "æµ‹è¯• 88alt ä»“åº“è¿žæŽ¥..."
          if (ssh -T git@github-88alt 2>&1 || true) | grep -q "88alt"; then
            echo "âœ… å¯†é’¥ 88alt è¿žæŽ¥æˆåŠŸ"
          else
            echo "âŒ å¯†é’¥ 88alt è¿žæŽ¥å¤±è´¥"
            EXIT_CODE=1
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… æ‰€æœ‰SSHè¿žæŽ¥éªŒè¯é€šè¿‡"
          else
            echo "âŒ SSHè¿žæŽ¥éªŒè¯å¤±è´¥"
            exit 1
          fi

      - name: 4. é…ç½®Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global init.defaultBranch main
          echo "âœ… Gité…ç½®å®Œæˆ"

      - name: 5. å…‹éš†æºä»“åº“
        run: |
          echo "æ­£åœ¨å…‹éš†æºä»“åº“..."
          
          SOURCE_REPO="https://github.com/MetaCubeX/meta-rules-dat.git"
          echo "æºä»“åº“: $SOURCE_REPO"
          
          # è®°å½•å¼€å§‹æ—¶é—´
          CLONE_START=$(date +%s)
          
          # å…‹éš†ä»“åº“ï¼ˆè®¾ç½®é‡è¯•æœºåˆ¶ï¼‰
          MAX_RETRY=3
          for i in $(seq 1 $MAX_RETRY); do
            echo "å…‹éš†å°è¯• $i/$MAX_RETRY..."
            
            # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›®å½•
            rm -rf meta-rules-dat.git 2>/dev/null || true
            
            if git clone --mirror "$SOURCE_REPO" meta-rules-dat.git; then
              CLONE_END=$(date +%s)
              CLONE_DURATION=$((CLONE_END - CLONE_START))
              echo "âœ… å…‹éš†æˆåŠŸï¼Œè€—æ—¶: ${CLONE_DURATION}ç§’"
              break
            elif [ $i -eq $MAX_RETRY ]; then
              echo "âŒ å…‹éš†å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
              exit 1
            else
              echo "å…‹éš†å¤±è´¥ï¼Œ10ç§’åŽé‡è¯• ($i/$MAX_RETRY)..."
              sleep 10
            fi
          done
          
          cd meta-rules-dat.git
          
          # åº”ç”¨å…³é”®é…ç½®
          echo "åº”ç”¨Gité…ç½®è§„åˆ™..."
          git config --unset-all remote.origin.fetch 2>/dev/null || true
          git config --add remote.origin.fetch '+refs/heads/*:refs/heads/*'
          git config --add remote.origin.fetch '+refs/tags/*:refs/tags/*'
          
          # æ¸…ç†PRå¼•ç”¨
          {
              git for-each-ref --format='delete %(refname)' refs/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— æœ¬åœ°PRå¼•ç”¨å¯æ¸…ç†"
          
          {
              git for-each-ref --format='delete %(refname)' refs/remotes/origin/pull 2>/dev/null | \
              git update-ref --stdin 2>/dev/null
          } 2>/dev/null || echo "æ— è¿œç¨‹PRå¼•ç”¨å¯æ¸…ç†"
          
          # èŽ·å–æœ€æ–°æ›´æ–°
          echo "èŽ·å–æœ€æ–°æ›´æ–°..."
          git fetch --prune origin
          
          echo "ä»“åº“ä¿¡æ¯:"
          echo "  åˆ†æ”¯: $(git branch -r | wc -l)"
          echo "  æ ‡ç­¾: $(git tag | wc -l)"
          echo "  å¤§å°: $(du -sh . | cut -f1)"
          
          cd ..

      - name: 6. æ‰§è¡Œé•œåƒåŒæ­¥
        id: sync_step
        run: |
          cd meta-rules-dat.git
          
          echo "=== å¼€å§‹åŒæ­¥é•œåƒä»“åº“ $(date '+%Y-%m-%d %H:%M:%S') UTC ==="
          
          # ä½¿ç”¨å…¨åè§„åˆ™çš„SSHä¸»æœºåˆ«å
          TARGET_REPOS=(
            "git@github-timeflysoon:timeflysoon/meta-rules-dat.git"
            "git@github-88alt:88alt/meta-rules-dat.git"
          )
          
          SYNC_START_TIME=$(date +%s)
          FAIL_COUNT=0
          
          for TARGET_REPO in "${TARGET_REPOS[@]}"; do
            REPO_HOST=$(echo "$TARGET_REPO" | cut -d'@' -f2 | cut -d':' -f1)
            REPO_PATH=$(echo "$TARGET_REPO" | cut -d':' -f2)
            
            echo "=== æŽ¨é€é•œåƒåˆ°: $REPO_HOST/$REPO_PATH ==="
            
            REPO_START_TIME=$(date +%s)
            PUSH_SUCCESS=false
            
            MAX_RETRY=2
            for i in $(seq 1 $MAX_RETRY); do
              echo "æŽ¨é€å°è¯• $i/$MAX_RETRY..."
              if git push --mirror "$TARGET_REPO"; then
                REPO_END_TIME=$(date +%s)
                REPO_DURATION=$((REPO_END_TIME - REPO_START_TIME))
                
                BRANCHES_COUNT=$(git branch -r | wc -l)
                TAGS_COUNT=$(git tag | wc -l)
                
                echo "âœ… æŽ¨é€æˆåŠŸ"
                echo "  åˆ†æ”¯: $BRANCHES_COUNT, æ ‡ç­¾: $TAGS_COUNT, è€—æ—¶: ${REPO_DURATION}ç§’"
                PUSH_SUCCESS=true
                break
              elif [ $i -eq $MAX_RETRY ]; then
                echo "âŒ æŽ¨é€å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰"
              else
                echo "æŽ¨é€å¤±è´¥ï¼Œ10ç§’åŽé‡è¯• ($i/$MAX_RETRY)..."
                sleep 10
              fi
            done
            
            if [ "$PUSH_SUCCESS" = false ]; then
              FAIL_COUNT=$((FAIL_COUNT + 1))
              echo "âš ï¸ æ ‡è®°æ­¤ä»“åº“åŒæ­¥å¤±è´¥"
            fi
          done
          
          SYNC_END_TIME=$(date +%s)
          TOTAL_DURATION=$((SYNC_END_TIME - SYNC_START_TIME))
          
          echo "=== åŒæ­¥å®Œæˆï¼Œæ€»è€—æ—¶: ${TOTAL_DURATION}ç§’ ==="
          echo "=== å¤±è´¥ä»“åº“æ•°: ${FAIL_COUNT} ==="
          
          if [ $FAIL_COUNT -gt 0 ]; then
            echo "âŒ æœ‰${FAIL_COUNT}ä¸ªä»“åº“åŒæ­¥å¤±è´¥"
            exit 1
          else
            echo "âœ… æ‰€æœ‰ä»“åº“åŒæ­¥æˆåŠŸ"
          fi

      - name: 7. æ¸…ç†æ•æ„Ÿæ•°æ®
        if: always()
        run: |
          echo "æ¸…ç†SSHå¯†é’¥æ–‡ä»¶..."
          rm -f ~/.ssh/id_ed25519_timeflysoon
          rm -f ~/.ssh/id_ed25519_88alt
          rm -f ~/.ssh/config
          rm -f ~/.ssh/known_hosts
          echo "âœ… æ•æ„Ÿæ•°æ®æ¸…ç†å®Œæˆ"

      - name: 8. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸš€ é•œåƒåŒæ­¥ä»»åŠ¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**è¿è¡Œä¿¡æ¯**:" >> $GITHUB_STEP_SUMMARY
          echo "- è§¦å‘æ–¹å¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡ŒçŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡ŒID: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- æºä»“åº“: [MetaCubeX/meta-rules-dat](https://github.com/MetaCubeX/meta-rules-dat)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**åŒæ­¥ç›®æ ‡**:" >> $GITHUB_STEP_SUMMARY
          echo "1. timeflysoon/meta-rules-datï¼ˆä½¿ç”¨å…¨åå¯†é’¥ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "2. 88alt/meta-rules-datï¼ˆä½¿ç”¨å…¨åå¯†é’¥ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # èŽ·å–åŒæ­¥æ­¥éª¤çš„ç»“æžœ
          SYNC_OUTCOME="${{ steps.sync_step.outcome }}"
          
          if [[ "$SYNC_OUTCOME" == "success" ]]; then
            echo "âœ… **æ‰§è¡Œç»“æžœ**: åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰ç›®æ ‡ä»“åº“å‡å·²åŒæ­¥æœ€æ–°å†…å®¹ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ‰§è¡Œç»“æžœ**: åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "éƒ¨åˆ†ä»“åº“åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—æŽ’æŸ¥é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S') UTC" >> $GITHUB_STEP_SUMMARY
