steps:
  - name: Checkout repository
    uses: actions/checkout@v4
    with:
      token: ${{ secrets.GITHUB_TOKEN }}
      fetch-depth: 1

  - name: Setup Git
    run: |
      git config user.name "github-actions[bot]"
      git config user.email "github-actions[bot]@users.noreply.github.com"

  - name: Delete meta directory if exists
    run: |
      echo "ğŸ—‘ï¸  åˆ é™¤ meta ç›®å½•..."
      
      if [ -d "meta" ]; then
        echo "æ‰¾åˆ° meta ç›®å½•ï¼Œæ­£åœ¨åˆ é™¤..."
        rm -rf meta
        echo "âœ… meta ç›®å½•å·²åˆ é™¤"
      else
        echo "â„¹ï¸  meta ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"
      fi

  - name: Clone source repository to meta directory
    run: |
      echo "ğŸ“¥ å…‹éš†æºä»“åº“åˆ° meta ç›®å½•..."
      
      # ç›´æ¥å…‹éš†æºä»“åº“åˆ° meta ç›®å½•
      git clone --depth=1 --branch=meta https://github.com/MetaCubeX/meta-rules-dat.git meta
      
      echo "å…‹éš†å®Œæˆï¼Œæ¸…ç†ä¸éœ€è¦çš„ç›®å½•..."
      
      # åˆ é™¤æºä»“åº“çš„ .git ç›®å½•ï¼ˆæˆ‘ä»¬ä¸æƒ³è¦å­ä»“åº“ï¼‰
      rm -rf meta/.git
      
      # ç¡®ä¿æ²¡æœ‰ .github ç›®å½•ï¼ˆå¦‚æœæºä»“åº“æœ‰ï¼‰
      rm -rf meta/.github 2>/dev/null || true
      
      echo "âœ… å…‹éš†å®Œæˆ"

  - name: Verify sync result
    run: |
      echo "ğŸ” éªŒè¯åŒæ­¥ç»“æœ..."
      
      echo "meta ç›®å½•å†…å®¹:"
      ls -la meta/
      
      echo ""
      echo "å„ç›®å½•æ–‡ä»¶ç»Ÿè®¡:"
      for dir in meta/*/; do
        if [ -d "$dir" ]; then
          dir_name=$(basename "$dir")
          file_count=$(find "$dir" -type f | wc -l)
          echo "  ğŸ“ $dir_name: $file_count ä¸ªæ–‡ä»¶"
        fi
      done

  - name: Remove any .dat files (safety check)
    run: |
      echo "ğŸ” æ£€æŸ¥æ˜¯å¦æœ‰ .dat æ–‡ä»¶..."
      
      if find meta -name "*.dat" -type f 2>/dev/null | grep -q .; then
        echo "å‘ç° .dat æ–‡ä»¶ï¼Œæ­£åœ¨åˆ é™¤..."
        find meta -name "*.dat" -type f -delete
        echo "âœ… å·²åˆ é™¤ .dat æ–‡ä»¶"
      else
        echo "âœ“ æ²¡æœ‰ .dat æ–‡ä»¶"
      fi

  - name: Check for git changes
    id: check_git
    run: |
      echo "ğŸ“Š æ£€æŸ¥ Git å˜åŒ–..."
      
      # æ·»åŠ æ‰€æœ‰å˜åŒ–
      git add -A
      
      # æ£€æŸ¥æ˜¯å¦æœ‰å¾…æäº¤çš„æ›´æ”¹
      if git diff --cached --quiet; then
        echo "â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ° Git å˜åŒ–"
        echo "has_git_changes=false" >> $GITHUB_OUTPUT
      else
        CHANGED_COUNT=$(git diff --cached --name-only | wc -l)
        echo "ğŸ“ æ£€æµ‹åˆ° $CHANGED_COUNT ä¸ªæ–‡ä»¶å˜åŒ–"
        echo "has_git_changes=true" >> $GITHUB_OUTPUT
        echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
        
        echo "å˜åŒ–æ–‡ä»¶åˆ—è¡¨:"
        git diff --cached --name-only | head -10
      fi

  - name: Commit and push changes
    if: steps.check_git.outputs.has_git_changes == 'true'
    run: |
      TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
      CHANGED_COUNT="${{ steps.check_git.outputs.changed_count }}"
      
      if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
        SYNC_TYPE="æ‰‹åŠ¨åŒæ­¥"
      else
        SYNC_TYPE="å®šæ—¶åŒæ­¥"
      fi
      
      COMMIT_MSG="ğŸ”„ $SYNC_TYPE: æ›´æ–° MetaCubeX meta æ–‡ä»¶å¤¹
      
      ä¿æŒä¸æºä»“åº“å®Œå…¨ä¸€è‡´ï¼ŒåŒæ­¥æ‰€æœ‰æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ã€‚
      
      è¯¦ç»†ä¿¡æ¯:
      - æºä»“åº“: MetaCubeX/meta-rules-dat@meta åˆ†æ”¯
      - åŒæ­¥æ—¶é—´: $TIMESTAMP
      - åŒæ­¥ç±»å‹: $SYNC_TYPE
      - å˜åŒ–æ–‡ä»¶æ•°: $CHANGED_COUNT
      - è§¦å‘æ–¹å¼: ${{ github.event_name }}
      
      ç”± GitHub Actions è‡ªåŠ¨åŒæ­¥"
      
      git commit -m "$COMMIT_MSG"
      git push origin main
      
      echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ–°"

  - name: No changes needed
    if: steps.check_git.outputs.has_git_changes == 'false'
    run: |
      echo "ğŸ‰ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
      echo "å½“å‰ meta ç›®å½•ç»“æ„:"
      ls -la meta/
      echo ""
      echo "ä¸æºä»“åº“å®Œå…¨ä¸€è‡´ âœ“"

  - name: Final summary
    run: |
      echo "=== åŒæ­¥ä»»åŠ¡å®Œæˆ ==="
      echo "å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
      
      if [ "${{ steps.check_git.outputs.has_git_changes }}" = "true" ]; then
        echo "âœ… ç»“æœ: å·²åŒæ­¥å¹¶æäº¤ ${{ steps.check_git.outputs.changed_count }} ä¸ªæ–‡ä»¶æ›´æ–°"
      else
        echo "â„¹ï¸  ç»“æœ: æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
      fi
      
      echo ""
      echo "meta ç›®å½•æœ€ç»ˆçŠ¶æ€:"
      if [ -d "meta" ]; then
        ls -la meta/
        
        echo ""
        echo "ç›®å½•æ—¶é—´æˆ³:"
        for dir in meta/*/; do
          if [ -d "$dir" ]; then
            dir_name=$(basename "$dir")
            dir_time=$(stat -c %y "$dir" 2>/dev/null || stat -f %Sm "$dir" 2>/dev/null || echo "unknown")
            file_count=$(find "$dir" -type f | wc -l)
            echo "  ğŸ“ $dir_name: $file_count ä¸ªæ–‡ä»¶, æ›´æ–°æ—¶é—´: $dir_time"
          fi
        done
      else
        echo "âŒ é”™è¯¯: meta ç›®å½•ä¸å­˜åœ¨"
      fi
      
      echo ""
      echo "ä»»åŠ¡çŠ¶æ€: å®Œæˆ âœ“"
