name: Fix and Sync Meta Rules

on:
  workflow_dispatch:
    inputs:
      fix_structure:
        description: 'ä¿®å¤ç›®å½•ç»“æ„'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write

jobs:
  fix-and-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2

      - name: Setup environment
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ˜¾ç¤ºå½“å‰ç›®å½•ç»“æ„
          echo "å½“å‰ç›®å½•ç»“æ„:"
          find . -maxdepth 3 -type d | sort

      - name: Fix directory structure
        if: github.event.inputs.fix_structure == 'true'
        run: |
          echo "=== ä¿®å¤ç›®å½•ç»“æ„ ==="
          
          # 1. åˆ é™¤é”™è¯¯çš„ rules/meta ç›®å½•
          if [ -d "rules/meta" ]; then
            echo "åˆ é™¤é”™è¯¯çš„ rules/meta ç›®å½•..."
            rm -rf rules/meta
            
            # æ£€æŸ¥ rules ç›®å½•æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯åˆ™åˆ é™¤
            if [ -d "rules" ] && [ -z "$(ls -A rules 2>/dev/null)" ]; then
              echo "rules ç›®å½•ä¸ºç©ºï¼Œåˆ é™¤..."
              rm -rf rules
            fi
            
            echo "âœ… å·²åˆ é™¤ rules/meta"
          else
            echo "rules/meta ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"
          fi
          
          # 2. åˆ é™¤æ ¹ç›®å½•ä¸‹çš„ meta ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼Œæˆ‘ä»¬åé¢ä¼šé‡æ–°åˆ›å»ºï¼‰
          if [ -d "meta" ]; then
            echo "åˆ é™¤æ—§çš„ meta ç›®å½•..."
            rm -rf meta
            echo "âœ… å·²åˆ é™¤æ—§çš„ meta ç›®å½•"
          fi
          
          # 3. æ˜¾ç¤ºä¿®å¤åçš„ç»“æ„
          echo "ä¿®å¤åçš„ç›®å½•ç»“æ„:"
          find . -maxdepth 2 -type d | sort

      - name: Get source repository
        id: get_source
        run: |
          SOURCE_DIR="/tmp/meta-source-$(date +%s)"
          echo "source_dir=$SOURCE_DIR" >> $GITHUB_OUTPUT
          
          echo "å…‹éš†æºä»“åº“çš„ meta åˆ†æ”¯..."
          if ! git clone --depth=1 --branch=meta https://github.com/MetaCubeX/meta-rules-dat.git "$SOURCE_DIR"; then
            echo "âŒ å…‹éš†å¤±è´¥"
            exit 1
          fi
          
          echo "æºä»“åº“ç»“æ„:"
          ls -la "$SOURCE_DIR/"
          
          echo "âœ… æºä»“åº“è·å–æˆåŠŸ"

      - name: Create correct meta directory
        run: |
          echo "åˆ›å»ºæ­£ç¡®çš„ meta ç›®å½•ç»“æ„..."
          
          # åˆ›å»ºæ ¹ç›®å½•ä¸‹çš„ meta ç›®å½•
          mkdir -p meta
          
          # åŒæ­¥æºä»“åº“çš„æ–‡ä»¶å¤¹ç»“æ„
          SOURCE_DIR="${{ steps.get_source.outputs.source_dir }}"
          
          echo "åŒæ­¥æ–‡ä»¶å¤¹ç»“æ„..."
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='README.md' \
            --exclude='LICENSE' \
            --exclude='*.yml' \
            --exclude='*.yaml' \
            --exclude='Makefile' \
            "$SOURCE_DIR/" "meta/"
          
          echo "âœ… æ–‡ä»¶å¤¹åŒæ­¥å®Œæˆ"
          echo "åŒæ­¥å meta ç›®å½•ç»“æ„:"
          ls -la meta/

      - name: Download binary files
        run: |
          echo "ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶..."
          
          # å®šä¹‰éœ€è¦ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ—è¡¨
          declare -A BINARY_FILES=(
            ["geoip.dat"]="https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip.dat"
            ["geoip-lite.dat"]="https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat"
            ["geosite.dat"]="https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat"
            ["geosite-lite.dat"]="https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite-lite.dat"
          )
          
          for filename in "${!BINARY_FILES[@]}"; do
            url="${BINARY_FILES[$filename]}"
            echo "ä¸‹è½½: $filename"
            
            if curl -L -o "meta/$filename" "$url" --fail --silent; then
              FILE_SIZE=$(stat -c%s "meta/$filename" 2>/dev/null || echo "0")
              echo "  âœ… æˆåŠŸ ($((FILE_SIZE/1024)) KB)"
            else
              echo "  âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡"
              rm -f "meta/$filename" 2>/dev/null || true
            fi
          done

      - name: Commit and push changes
        run: |
          echo "æäº¤æ›´æ”¹..."
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          else
            # åˆ›å»ºæäº¤
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            COMMIT_MSG="ğŸ”§ ä¿®å¤ç›®å½•ç»“æ„å¹¶åŒæ­¥ MetaCubeX è§„åˆ™
            
            ä¿®å¤å†…å®¹:
            - åˆ é™¤é”™è¯¯çš„ rules/meta ç›®å½•
            - åˆ›å»ºæ­£ç¡®çš„ meta/ ç›®å½•ï¼ˆæ ¹ç›®å½•ä¸‹ï¼‰
            - åŒæ­¥æºä»“åº“çš„æ–‡ä»¶å¤¹ç»“æ„
            - ä¸‹è½½æœ€æ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶
            
            è¯¦ç»†ä¿¡æ¯:
            - æºä»“åº“: MetaCubeX/meta-rules-dat@meta
            - ä¿®å¤æ—¶é—´: $TIMESTAMP
            - ç›®å½•ç»“æ„: meta/ (æ ¹ç›®å½•)
            
            ç”± GitHub Actions è‡ªåŠ¨ä¿®å¤å’ŒåŒæ­¥"
            
            git commit -m "$COMMIT_MSG"
            
            # æ¨é€åˆ°è¿œç¨‹
            git push origin main
            
            echo "âœ… å·²æäº¤å¹¶æ¨é€ä¿®å¤"
          fi

      - name: Show final structure
        run: |
          echo "=== æœ€ç»ˆç›®å½•ç»“æ„ ==="
          echo "æ ¹ç›®å½•å†…å®¹:"
          ls -la
          echo ""
          echo "meta ç›®å½•å†…å®¹:"
          ls -la meta/
