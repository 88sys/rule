name: Update All Fork Repositories

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 03:00 å’Œ 15:00 è‡ªåŠ¨è¿è¡Œï¼ŒåŒæ­¥æ‰€æœ‰forkä»“åº“
    - cron: '0 19 * * *'  # UTC 19:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 03:00
    - cron: '0 7 * * *'   # UTC 07:00 = åŒ—äº¬æ—¶é—´å½“å¤© 15:00
  workflow_dispatch:
    inputs:
      repositories:
        description: |
          è¦æ›´æ–°çš„ä»“åº“ï¼š
          ç•™ç©º - ä»…æ›´æ–°å½“å‰ä»“åº“
          all - æ›´æ–°æ‰€æœ‰forkä»“åº“
          æŒ‡å®š - owner/repo,owner2/repo2
        required: false
        default: ""

permissions:
  contents: read

jobs:
  update-repos:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€æŸ¥é…ç½®
      run: |
        if [ -z "${{ secrets.AUTH_PAT }}" ]; then
          echo "âŒ è¯·å…ˆé…ç½® AUTH_PAT"
          echo "åœ¨ä»“åº“ Settings â†’ Secrets â†’ Actions ä¸­æ·»åŠ  PAT"
          echo "PAT éœ€è¦ repo æƒé™"
          exit 1
        fi
        
    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl git
        
    - name: ç¡®å®šæ›´æ–°æ¨¡å¼
      id: determine-mode
      run: |
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        
        if [ "${{ github.event_name }}" = "schedule" ]; then
          # å®šæ—¶ä»»åŠ¡ï¼šé»˜è®¤æ›´æ–°æ‰€æœ‰forkä»“åº“
          echo "ğŸ• å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œä½¿ç”¨ 'all' æ¨¡å¼"
          echo "mode=all" >> $GITHUB_OUTPUT
        else
          # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨ç”¨æˆ·è¾“å…¥
          USER_INPUT="${{ github.event.inputs.repositories }}"
          echo "ğŸ‘† æ‰‹åŠ¨è§¦å‘ï¼Œç”¨æˆ·è¾“å…¥: '$USER_INPUT'"
          
          if [ -z "$USER_INPUT" ]; then
            echo "ç”¨æˆ·è¾“å…¥ä¸ºç©ºï¼Œæ›´æ–°å½“å‰ä»“åº“"
            echo "mode=current" >> $GITHUB_OUTPUT
          elif [ "$USER_INPUT" = "all" ]; then
            echo "ç”¨æˆ·è¾“å…¥ 'all'ï¼Œæ›´æ–°æ‰€æœ‰forkä»“åº“"
            echo "mode=all" >> $GITHUB_OUTPUT
          else
            echo "ç”¨æˆ·æŒ‡å®šä»“åº“: $USER_INPUT"
            echo "mode=manual" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: è·å–æ‰€æœ‰forkä»“åº“åˆ—è¡¨ï¼ˆå¦‚æœæ˜¯allæ¨¡å¼ï¼‰
      if: steps.determine-mode.outputs.mode == 'all'
      id: get-all-fork-repos
      env:
        GH_TOKEN: ${{ secrets.AUTH_PAT }}
      run: |
        echo "ğŸ” æ­£åœ¨è·å–æ‚¨æ‰€æœ‰çš„forkä»“åº“..."
        
        page=1
        ALL_FORK_REPOS=""
        
        while true; do
          echo "è·å–ç¬¬ $page é¡µ..."
          RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
                        "https://api.github.com/user/repos?per_page=100&page=$page&type=owner&sort=full_name")
          
          # æ£€æŸ¥APIå“åº”
          if echo "$RESPONSE" | jq 'type' 2>/dev/null | grep -q "array"; then
            # æå–forkä»“åº“
            FORK_REPOS=$(echo "$RESPONSE" | jq -r '.[] | select(.fork == true) | .full_name' | tr '\n' ',')
            
            if [ -z "$FORK_REPOS" ] || [ "$FORK_REPOS" = "" ]; then
              echo "æ²¡æœ‰æ›´å¤šforkä»“åº“"
              break
            fi
            
            ALL_FORK_REPOS="${ALL_FORK_REPOS}${FORK_REPOS}"
            REPO_COUNT=$(echo "$FORK_REPOS" | tr ',' '\n' | wc -l)
            echo "ç¬¬ $page é¡µæ‰¾åˆ° $REPO_COUNT ä¸ªforkä»“åº“"
            
            page=$((page + 1))
            
            if [ $page -gt 5 ]; then
              echo "âš ï¸ å·²è·å–æœ€å¤š 500 ä¸ªä»“åº“"
              break
            fi
            
            sleep 1
          else
            echo "API å“åº”å¼‚å¸¸ï¼Œè·³è¿‡"
            break
          fi
        done
        
        if [ -n "$ALL_FORK_REPOS" ]; then
          ALL_FORK_REPOS=${ALL_FORK_REPOS%,}
          TOTAL_COUNT=$(echo "$ALL_FORK_REPOS" | tr ',' '\n' | wc -l)
          echo "fork_repositories=$ALL_FORK_REPOS" >> $GITHUB_OUTPUT
          echo "âœ… å…±æ‰¾åˆ° $TOTAL_COUNT ä¸ªforkä»“åº“"
        else
          echo "fork_repositories=" >> $GITHUB_OUTPUT
          echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•forkä»“åº“"
        fi
        
    - name: å‡†å¤‡ä»“åº“åˆ—è¡¨
      id: prepare-repos
      run: |
        MODE="${{ steps.determine-mode.outputs.mode }}"
        USER_INPUT="${{ github.event.inputs.repositories }}"
        
        echo "å‡†å¤‡æ¨¡å¼: $MODE"
        
        if [ "$MODE" = "all" ]; then
          # ä½¿ç”¨æ‰€æœ‰forkä»“åº“
          FINAL_REPOS="${{ steps.get-all-fork-repos.outputs.fork_repositories }}"
          if [ -z "$FINAL_REPOS" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°forkä»“åº“ï¼Œæ›´æ–°å½“å‰ä»“åº“"
            FINAL_REPOS="${{ github.repository }}"
          else
            echo "ğŸš€ å°†æ›´æ–°æ‰€æœ‰forkä»“åº“"
          fi
        elif [ "$MODE" = "current" ]; then
          # ä»…å½“å‰ä»“åº“
          FINAL_REPOS="${{ github.repository }}"
          echo "ğŸ“ å°†æ›´æ–°å½“å‰ä»“åº“: $FINAL_REPOS"
        else
          # æ‰‹åŠ¨æŒ‡å®šçš„ä»“åº“
          FINAL_REPOS="$USER_INPUT"
          echo "ğŸ¯ å°†æ›´æ–°æŒ‡å®šä»“åº“: $FINAL_REPOS"
        fi
        
        # æ¸…ç†æ ¼å¼
        FINAL_REPOS=$(echo "$FINAL_REPOS" | tr -d ' ' | sed 's/,,*/,/g' | sed 's/^,//' | sed 's/,$//')
        
        echo "repositories=$FINAL_REPOS" >> $GITHUB_OUTPUT
        REPO_COUNT=$(echo "$FINAL_REPOS" | tr ',' '\n' | wc -l)
        echo "repo_count=$REPO_COUNT" >> $GITHUB_OUTPUT
        
    - name: æ›´æ–°ä»“åº“
      env:
        REPOSITORIES: ${{ steps.prepare-repos.outputs.repositories }}
        GH_TOKEN: ${{ secrets.AUTH_PAT }}
      run: |
        echo "ğŸ”„ å¼€å§‹æ›´æ–°ä»“åº“..."
        echo "ä»“åº“åˆ—è¡¨: $REPOSITORIES"
        echo "æ€»ä»“åº“æ•°: ${{ steps.prepare-repos.outputs.repo_count }}"
        
        if [ -z "$REPOSITORIES" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šè¦æ›´æ–°çš„ä»“åº“"
          exit 1
        fi
        
        IFS=',' read -ra REPO_ARRAY <<< "$REPOSITORIES"
        
        UPDATED_REPOS=0
        UP_TO_DATE_REPOS=0
        SKIPPED_REPOS=0
        FAILED_REPOS=0
        
        for TARGET_REPO in "${REPO_ARRAY[@]}"; do
          echo ""
          echo "========================================"
          echo "ğŸ”„ æ›´æ–°ä»“åº“ ($((UPDATED_REPOS + UP_TO_DATE_REPOS + SKIPPED_REPOS + FAILED_REPOS + 1))/${#REPO_ARRAY[@]}): $TARGET_REPO"
          echo "========================================"
          
          # è·³è¿‡ç©ºå€¼
          if [ -z "$TARGET_REPO" ]; then
            echo "è·³è¿‡ç©ºä»“åº“å"
            SKIPPED_REPOS=$((SKIPPED_REPOS + 1))
            continue
          fi
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨PATï¼‰
          echo "ğŸ“¥ å…‹éš†ä»“åº“..."
          if ! git clone "https://x-access-token:$GH_TOKEN@github.com/$TARGET_REPO.git" . 2>/dev/null; then
            echo "âŒ å…‹éš†ä»“åº“å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰æƒé™"
            cd /
            rm -rf "$TEMP_DIR"
            FAILED_REPOS=$((FAILED_REPOS + 1))
            continue
          fi
          
          # è®¾ç½®Gitç”¨æˆ·
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # è·å–ä¸Šæ¸¸ä»“åº“ä¿¡æ¯
          echo "ğŸ“¡ è·å–ä¸Šæ¸¸ä»“åº“ä¿¡æ¯..."
          REPO_INFO=$(curl -s -H "Authorization: token $GH_TOKEN" \
                      "https://api.github.com/repos/$TARGET_REPO")
          
          PARENT_REPO=$(echo "$REPO_INFO" | jq -r '.parent.full_name // empty')
          
          if [ -z "$PARENT_REPO" ] || [ "$PARENT_REPO" = "null" ]; then
            echo "âš ï¸ $TARGET_REPO ä¸æ˜¯forkä»“åº“ï¼Œè·³è¿‡"
            cd /
            rm -rf "$TEMP_DIR"
            SKIPPED_REPOS=$((SKIPPED_REPOS + 1))
            continue
          fi
          
          echo "âœ… ä¸Šæ¸¸ä»“åº“: $PARENT_REPO"
          
          # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹
          echo "ğŸ”— æ·»åŠ ä¸Šæ¸¸ä»“åº“..."
          git remote add upstream "https://github.com/$PARENT_REPO.git" 2>/dev/null || true
          
          # è·å–æ‰€æœ‰ä¸Šæ¸¸åˆ†æ”¯
          echo "ğŸ“¡ è·å–ä¸Šæ¸¸åˆ†æ”¯..."
          if ! git fetch upstream 2>/dev/null; then
            echo "âŒ è·å–ä¸Šæ¸¸åˆ†æ”¯å¤±è´¥ï¼Œå¯èƒ½ä¸Šæ¸¸ä»“åº“ä¸å­˜åœ¨"
            cd /
            rm -rf "$TEMP_DIR"
            FAILED_REPOS=$((FAILED_REPOS + 1))
            continue
          fi
          
          # è·å–æ‰€æœ‰ä¸Šæ¸¸åˆ†æ”¯å
          UPSTREAM_BRANCHES=$(git branch -r | grep 'upstream/' | sed 's/upstream\///' | grep -v HEAD)
          
          if [ -z "$UPSTREAM_BRANCHES" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°ä¸Šæ¸¸åˆ†æ”¯ï¼Œè·³è¿‡"
            cd /
            rm -rf "$TEMP_DIR"
            SKIPPED_REPOS=$((SKIPPED_REPOS + 1))
            continue
          fi
          
          echo "ğŸŒ¿ æ‰¾åˆ°ä¸Šæ¸¸åˆ†æ”¯: $UPSTREAM_BRANCHES"
          
          # ä¿å­˜åŸå§‹åˆ†æ”¯
          ORIG_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
          
          # æ›´æ–°æ¯ä¸ªåˆ†æ”¯ï¼ˆä¸æ¨é€ï¼‰
          UPDATED_BRANCHES=0
          UP_TO_DATE_BRANCHES=0
          
          for BRANCH in $UPSTREAM_BRANCHES; do
            BRANCH=$(echo "$BRANCH" | xargs)
            [ -z "$BRANCH" ] && continue
            
            echo "  å¤„ç†åˆ†æ”¯: $BRANCH"
            
            # æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰è¿™ä¸ªåˆ†æ”¯
            if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
              echo "    åˆ†æ”¯å·²å­˜åœ¨"
              git checkout "$BRANCH" 2>/dev/null || git checkout -b "$BRANCH" "upstream/$BRANCH"
              
              # è·å–æœ¬åœ°å’Œä¸Šæ¸¸çš„æäº¤å“ˆå¸Œ
              LOCAL_HASH=$(git rev-parse HEAD 2>/dev/null || echo "")
              UPSTREAM_HASH=$(git rev-parse "upstream/$BRANCH" 2>/dev/null || echo "")
              
              if [ -z "$LOCAL_HASH" ] || [ -z "$UPSTREAM_HASH" ]; then
                echo "    âš ï¸ æ— æ³•è·å–æäº¤å“ˆå¸Œï¼Œè·³è¿‡"
                continue
              fi
              
              if [ "$LOCAL_HASH" = "$UPSTREAM_HASH" ]; then
                echo "    âœ… å·²æ˜¯æœ€æ–°"
                UP_TO_DATE_BRANCHES=$((UP_TO_DATE_BRANCHES + 1))
              else
                echo "    ğŸ”„ å‘ç°æ›´æ–°"
                echo "      æœ¬åœ°: $LOCAL_HASH"
                echo "      ä¸Šæ¸¸: $UPSTREAM_HASH"
                
                # åˆå¹¶ä¸Šæ¸¸æ›´æ–°ï¼ˆä¸æ¨é€ï¼‰
                if git merge --no-edit "upstream/$BRANCH" 2>/dev/null; then
                  echo "    âœ… åˆå¹¶æˆåŠŸ"
                else
                  echo "    âš ï¸ åˆå¹¶å†²çªï¼Œä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬"
                  git reset --hard "upstream/$BRANCH"
                fi
                
                UPDATED_BRANCHES=$((UPDATED_BRANCHES + 1))
              fi
            else
              echo "    ğŸŒ± åˆ›å»ºæ–°åˆ†æ”¯ï¼ˆä»…æœ¬åœ°ï¼‰"
              git checkout -b "$BRANCH" "upstream/$BRANCH"
              UPDATED_BRANCHES=$((UPDATED_BRANCHES + 1))
            fi
          done
          
          # æ¢å¤åŸå§‹åˆ†æ”¯
          if [ -n "$ORIG_BRANCH" ]; then
            git checkout "$ORIG_BRANCH" 2>/dev/null || true
          fi
          
          # æ¸…ç†
          cd /
          rm -rf "$TEMP_DIR"
          
          if [ $UPDATED_BRANCHES -gt 0 ]; then
            echo "âœ… $TARGET_REPO æ›´æ–°å®Œæˆ ($UPDATED_BRANCHES ä¸ªåˆ†æ”¯æœ‰æ›´æ–°)"
            UPDATED_REPOS=$((UPDATED_REPOS + 1))
          else
            echo "â­ï¸ $TARGET_REPO å·²æ˜¯æœ€æ–° ($UP_TO_DATE_BRANCHES ä¸ªåˆ†æ”¯å·²æœ€æ–°)"
            UP_TO_DATE_REPOS=$((UP_TO_DATE_REPOS + 1))
          fi
        done
        
        echo ""
        echo "ğŸ‰ æ›´æ–°å®Œæˆï¼ˆæœ¬åœ°æ›´æ–°ï¼Œæœªæ¨é€ï¼‰"
        echo "ğŸ“Š ç»Ÿè®¡ï¼š"
        echo "  âœ… æœ‰æ›´æ–°çš„ä»“åº“: $UPDATED_REPOS"
        echo "  â­ï¸  å·²æœ€æ–°çš„ä»“åº“: $UP_TO_DATE_REPOS"
        echo "  ğŸ”„ è·³è¿‡çš„ä»“åº“: $SKIPPED_REPOS"
        echo "  âŒ å¤±è´¥çš„ä»“åº“: $FAILED_REPOS"
        
        # è®¾ç½®è¾“å‡º
        echo "updated_repos=$UPDATED_REPOS" >> $GITHUB_OUTPUT
        echo "up_to_date_repos=$UP_TO_DATE_REPOS" >> $GITHUB_OUTPUT
        echo "skipped_repos=$SKIPPED_REPOS" >> $GITHUB_OUTPUT
        echo "failed_repos=$FAILED_REPOS" >> $GITHUB_OUTPUT
        
    - name: ç”ŸæˆæŠ¥å‘Š
      if: always()
      env:
        MODE: ${{ steps.determine-mode.outputs.mode }}
        REPO_COUNT: ${{ steps.prepare-repos.outputs.repo_count }}
        UPDATED_REPOS: ${{ steps.update-repos.outputs.updated_repos || 0 }}
        UP_TO_DATE_REPOS: ${{ steps.update-repos.outputs.up_to_date_repos || 0 }}
        SKIPPED_REPOS: ${{ steps.update-repos.outputs.skipped_repos || 0 }}
        FAILED_REPOS: ${{ steps.update-repos.outputs.failed_repos || 0 }}
      run: |
        echo "## ğŸ“Š ä»“åº“æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ›´æ–°æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**æ›´æ–°æ¨¡å¼:** $MODE" >> $GITHUB_STEP_SUMMARY
        echo "**ç›®æ ‡ä»“åº“æ•°:** $REPO_COUNT ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "**çŠ¶æ€:** âœ… æ›´æ–°ä»»åŠ¡æ‰§è¡Œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ æ›´æ–°ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ€ | ä»“åº“æ•° | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… æœ‰æ›´æ–° | $UPDATED_REPOS | æœ¬åœ°åˆ†æ”¯å·²æ›´æ–°ï¼ˆæœªæ¨é€ï¼‰ |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ å·²æœ€æ–° | $UP_TO_DATE_REPOS | æ‰€æœ‰åˆ†æ”¯å·²æ˜¯æœ€æ–° |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”„ è·³è¿‡ | $SKIPPED_REPOS | éforkä»“åº“æˆ–æ— åˆ†æ”¯ |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ å¤±è´¥ | $FAILED_REPOS | æƒé™æˆ–ç½‘ç»œé—®é¢˜ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ æ€»è®¡ | $REPO_COUNT | ç›®æ ‡ä»“åº“æ€»æ•° |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ è¯´æ˜" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **ä»…æœ¬åœ°æ›´æ–°**ï¼šæ›´æ–°åªåœ¨ GitHub Actions è¿è¡Œç¯å¢ƒä¸­ç”Ÿæ•ˆ" >> $GITHUB_STEP_SUMMARY
          echo "2. **æœªæ¨é€**ï¼šæ²¡æœ‰æ‰§è¡Œ `git push`ï¼Œä¸ä¼šè§¦å‘å…¶ä»–ä»“åº“çš„ Actions" >> $GITHUB_STEP_SUMMARY
          echo "3. **å®šæ—¶ä»»åŠ¡**ï¼šè‡ªåŠ¨åŒæ­¥æ‰€æœ‰forkä»“åº“çš„æ‰€æœ‰åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          echo "4. **æ‰‹åŠ¨è§¦å‘**ï¼šæ”¯æŒå¤šç§è¾“å…¥æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ”„ ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°æ—¶é—´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- åŒ—äº¬æ—¶é—´ 03:00ï¼ˆUTC å‰ä¸€å¤© 19:00ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- åŒ—äº¬æ—¶é—´ 15:00ï¼ˆUTC å½“å¤© 07:00ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> âš ï¸ æ³¨æ„ï¼šå®šæ—¶ä»»åŠ¡é»˜è®¤æ›´æ–°æ‰€æœ‰forkä»“åº“ï¼Œå¦‚éœ€ä¿®æ”¹è¯·åœ¨æ‰‹åŠ¨è§¦å‘æ—¶æŒ‡å®š" >> $GITHUB_STEP_SUMMARY
        else
          echo "**çŠ¶æ€:** âŒ æ›´æ–°ä»»åŠ¡æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
