name: Sync Current Fork

on:
  schedule:
    - cron: '0 19 * * *'  # UTC 19:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 03:00
    - cron: '0 7 * * *'   # UTC 07:00 = åŒ—äº¬æ—¶é—´å½“å¤© 15:00
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: 'ä¸Šæ¸¸ä»“åº“ (æ ¼å¼: owner/repo)ï¼Œç•™ç©ºè‡ªåŠ¨æ£€æµ‹'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  sync-current:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
    - name: Determine upstream
      id: get-upstream
      run: |
        INPUT_REPO="${{ inputs.upstream_repo }}"
        
        if [ -z "$INPUT_REPO" ]; then
          echo "å°è¯•è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸..."
          
          # å¯¹äº OpenClashï¼Œé»˜è®¤ä¸Šæ¸¸æ˜¯ vernesong/OpenClash
          CURRENT_REPO="${{ github.repository }}"
          REPO_NAME=$(basename "$CURRENT_REPO")
          
          if [ "$REPO_NAME" == "OpenClash" ]; then
            UPSTREAM_REPO="vernesong/OpenClash"
          else
            # å°è¯•ä» git remote è·å–
            UPSTREAM_URL=$(git remote get-url upstream 2>/dev/null || echo "")
            if [ -n "$UPSTREAM_URL" ]; then
              # ä» URL ä¸­æå– owner/repo
              if [[ "$UPSTREAM_URL" =~ github\.com[:/]([^/]+)/([^/]+)\.git ]]; then
                UPSTREAM_REPO="${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
              else
                UPSTREAM_REPO=""
              fi
            else
              UPSTREAM_REPO=""
            fi
          fi
        else
          UPSTREAM_REPO="$INPUT_REPO"
        fi
        
        if [ -z "$UPSTREAM_REPO" ]; then
          echo "âŒ æ— æ³•ç¡®å®šä¸Šæ¸¸ä»“åº“"
          echo "has_upstream=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "ä¸Šæ¸¸ä»“åº“: $UPSTREAM_REPO"
          echo "upstream_repo=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
          echo "has_upstream=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Sync branches
      if: steps.get-upstream.outputs.has_upstream == 'true'
      env:
        UPSTREAM_REPO: ${{ steps.get-upstream.outputs.upstream_repo }}
      run: |
        echo "å¼€å§‹åŒæ­¥: $UPSTREAM_REPO"
        
        # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹
        git remote add upstream "https://github.com/$UPSTREAM_REPO.git" 2>/dev/null || \
          git remote set-url upstream "https://github.com/$UPSTREAM_REPO.git"
        
        # è·å–ä¸Šæ¸¸åˆ†æ”¯
        echo "è·å–ä¸Šæ¸¸åˆ†æ”¯..."
        git fetch upstream
        
        # æ˜¾ç¤ºæ‰€æœ‰åˆ†æ”¯
        echo "ä¸Šæ¸¸åˆ†æ”¯åˆ—è¡¨:"
        git branch -r | grep 'upstream/'
        
        # è·å–åˆ†æ”¯å
        BRANCHES=$(git branch -r | grep 'upstream/' | grep -v HEAD | sed 's/upstream\///')
        
        if [ -z "$BRANCHES" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°åˆ†æ”¯"
          exit 0
        fi
        
        echo "å°†åŒæ­¥ä»¥ä¸‹åˆ†æ”¯:"
        echo "$BRANCHES"
        
        # ä¿å­˜å½“å‰åˆ†æ”¯
        ORIG_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
        
        # åŒæ­¥æ¯ä¸ªåˆ†æ”¯
        for BRANCH in $BRANCHES; do
          echo "å¤„ç†åˆ†æ”¯: $BRANCH"
          
          BRANCH=$(echo "$BRANCH" | xargs)
          
          if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
            git checkout "$BRANCH"
            echo "åˆå¹¶ä¸Šæ¸¸æ›´æ–°..."
            if git merge --no-edit upstream/"$BRANCH"; then
              echo "âœ… åˆå¹¶æˆåŠŸ"
            else
              echo "âš ï¸ åˆå¹¶å†²çªï¼Œä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬"
              git reset --hard upstream/"$BRANCH"
            fi
          else
            git checkout -b "$BRANCH" upstream/"$BRANCH"
            echo "âœ… åˆ›å»ºæ–°åˆ†æ”¯"
          fi
          
          # æ¨é€
          echo "æ¨é€åˆ° origin..."
          git push origin "$BRANCH"
          echo "âœ… æ¨é€å®Œæˆ"
        done
        
        # æ¢å¤åŸåˆ†æ”¯
        if [ -n "$ORIG_BRANCH" ]; then
          git checkout "$ORIG_BRANCH" 2>/dev/null || true
        fi
        
        echo "ğŸ‰ åŒæ­¥å®Œæˆ"
