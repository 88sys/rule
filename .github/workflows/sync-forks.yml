name: Sync Fork from Upstream

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 03:00 å’Œ 15:00 è‡ªåŠ¨è¿è¡Œ
    - cron: '0 19 * * *'  # UTC 19:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 03:00
    - cron: '0 7 * * *'   # UTC 07:00 = åŒ—äº¬æ—¶é—´å½“å¤© 15:00
  workflow_dispatch:
    inputs:
      upstream_repos:
        description: |
          è¦åŒæ­¥çš„æºä»“åº“ (æ ¼å¼: owner/repo)
          å¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºä¸ºå½“å‰ä»“åº“
          è¾“å…¥ 'all' ä½¿ç”¨é»˜è®¤é…ç½®
        required: false
        default: 'all'
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå¿½ç•¥æ—¶é—´æ£€æŸ¥ï¼‰'
        type: boolean
        default: false

# éœ€è¦å†™æƒé™æ¥æŽ¨é€åˆ†æ”¯
permissions:
  contents: write

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–æ‰€æœ‰åˆ†æ”¯åŽ†å²
        
    - name: Setup Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
    - name: Determine upstream repository
      id: get-upstream
      env:
        INPUT_REPOS: ${{ inputs.upstream_repos }}
      run: |
        echo "è¾“å…¥å‚æ•°: '$INPUT_REPOS'"
        
        if [ -z "$INPUT_REPOS" ]; then
          echo "è¾“å…¥ä¸ºç©ºï¼Œä½¿ç”¨å½“å‰ä»“åº“çš„ä¸Šæ¸¸"
          
          # å¯¹äºŽ OpenClash ä»“åº“ï¼Œé»˜è®¤ä¸Šæ¸¸æ˜¯ vernesong/OpenClash
          CURRENT_REPO="${{ github.repository }}"
          REPO_NAME=$(basename "$CURRENT_REPO")
          
          if [ "$REPO_NAME" == "OpenClash" ]; then
            UPSTREAM_REPO="vernesong/OpenClash"
          else
            # å°è¯•èŽ·å–ä¸Šæ¸¸ä¿¡æ¯
            API_RESPONSE=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$CURRENT_REPO" || echo "{}")
            
            PARENT_REPO=$(echo "$API_RESPONSE" | jq -r '.parent.full_name // ""')
            
            if [ -n "$PARENT_REPO" ] && [ "$PARENT_REPO" != "null" ]; then
              UPSTREAM_REPO="$PARENT_REPO"
            else
              UPSTREAM_REPO=""
            fi
          fi
          
          if [ -z "$UPSTREAM_REPO" ]; then
            echo "âš ï¸ æ— æ³•è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸ä»“åº“ï¼Œè¯·æ‰‹åŠ¨æŒ‡å®š"
            echo "UPSTREAM_REPO=" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°ä¸Šæ¸¸: $UPSTREAM_REPO"
            echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
          fi
          
        elif [ "$INPUT_REPOS" == "all" ]; then
          echo "è¾“å…¥ 'all'ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          # å¯¹äºŽ OpenClashï¼Œé»˜è®¤ä¸Šæ¸¸æ˜¯ vernesong/OpenClash
          echo "UPSTREAM_REPO=vernesong/OpenClash" >> $GITHUB_OUTPUT
          
        else
          echo "ä½¿ç”¨æŒ‡å®šä»“åº“: $INPUT_REPOS"
          
          # å¦‚æžœåŒ…å«é€—å·ï¼Œåªå–ç¬¬ä¸€ä¸ª
          if [[ "$INPUT_REPOS" == *","* ]]; then
            FIRST_REPO=$(echo "$INPUT_REPOS" | cut -d',' -f1 | xargs)
            echo "å¤šä¸ªä»“åº“åªåŒæ­¥ç¬¬ä¸€ä¸ª: $FIRST_REPO"
            echo "UPSTREAM_REPO=$FIRST_REPO" >> $GITHUB_OUTPUT
          else
            echo "UPSTREAM_REPO=$INPUT_REPOS" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: Sync from upstream
      if: steps.get-upstream.outputs.UPSTREAM_REPO != ''
      env:
        UPSTREAM_REPO: ${{ steps.get-upstream.outputs.UPSTREAM_REPO }}
        FORCE_SYNC: ${{ inputs.force_sync }}
      run: |
        echo "å¼€å§‹åŒæ­¥ä¸Šæ¸¸ä»“åº“: $UPSTREAM_REPO"
        
        # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“
        git remote add upstream "https://github.com/$UPSTREAM_REPO.git" 2>/dev/null || \
          git remote set-url upstream "https://github.com/$UPSTREAM_REPO.git"
        
        # èŽ·å–æ‰€æœ‰ä¸Šæ¸¸åˆ†æ”¯
        echo "èŽ·å–ä¸Šæ¸¸æ‰€æœ‰åˆ†æ”¯..."
        git fetch upstream
        
        # èŽ·å–æ‰€æœ‰åˆ†æ”¯åˆ—è¡¨
        BRANCHES=$(git branch -r | grep 'upstream/' | grep -v 'HEAD' | sed 's/upstream\///')
        
        if [ -z "$BRANCHES" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•åˆ†æ”¯"
          exit 0
        fi
        
        echo "æ‰¾åˆ°ä»¥ä¸‹åˆ†æ”¯:"
        echo "$BRANCHES"
        
        # ä¿å­˜å½“å‰åˆ†æ”¯
        ORIGINAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
        
        # åŒæ­¥æ¯ä¸ªåˆ†æ”¯
        for BRANCH in $BRANCHES; do
          echo "æ­£åœ¨åŒæ­¥åˆ†æ”¯: $BRANCH"
          
          # æ¸…ç†åˆ†æ”¯å
          BRANCH=$(echo "$BRANCH" | xargs)
          
          if [ -z "$BRANCH" ]; then
            continue
          fi
          
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜åœ¨è¯¥åˆ†æ”¯
          if git show-ref --quiet "refs/heads/$BRANCH"; then
            echo "åˆ†æ”¯ $BRANCH å·²å­˜åœ¨ï¼Œåˆ‡æ¢åˆ°å¹¶åˆå¹¶..."
            git checkout "$BRANCH"
            git merge --no-edit upstream/"$BRANCH" || echo "åˆå¹¶å¯èƒ½å¤±è´¥ï¼Œç»§ç»­..."
          else
            echo "åˆ›å»ºæ–°åˆ†æ”¯: $BRANCH"
            git checkout -b "$BRANCH" upstream/"$BRANCH"
          fi
          
          # æŽ¨é€åˆ° origin
          echo "æŽ¨é€åˆ†æ”¯ $BRANCH..."
          git push origin "$BRANCH"
          
          echo "âœ… åˆ†æ”¯ $BRANCH åŒæ­¥å®Œæˆ"
        done
        
        # åˆ‡æ¢å›žåŽŸå§‹åˆ†æ”¯
        if [ -n "$ORIGINAL_BRANCH" ]; then
          git checkout "$ORIGINAL_BRANCH" 2>/dev/null || true
        fi
        
        echo "ðŸŽ‰ æ‰€æœ‰åˆ†æ”¯åŒæ­¥å®Œæˆ!"
        
    - name: Create summary
      if: always()
      run: |
        echo "## ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if ${{ steps.get-upstream.outputs.UPSTREAM_REPO != '' && success() }}; then
          echo "âœ… **åŒæ­¥æˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸ä»“åº“:** ${{ steps.get-upstream.outputs.UPSTREAM_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "**åŒæ­¥æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **åŒæ­¥å¤±è´¥æˆ–è·³è¿‡**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åŽŸå› :** ${{ steps.get-upstream.outputs.UPSTREAM_REPO == '' && 'æœªæ‰¾åˆ°ä¸Šæ¸¸ä»“åº“' || 'åŒæ­¥è¿‡ç¨‹ä¸­å‡ºçŽ°é”™è¯¯' }}" >> $GITHUB_STEP_SUMMARY
        fi
