name: Sync Fork from Upstream

on:
  schedule:
    - cron: '0 19 * * *'  # UTC 19:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 03:00
    - cron: '0 7 * * *'   # UTC 07:00 = åŒ—äº¬æ—¶é—´å½“å¤© 15:00
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: 'ä¸Šæ¸¸ä»“åº“ (æ ¼å¼: owner/repo)ï¼Œç•™ç©ºè‡ªåŠ¨æ£€æµ‹'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  sync-current:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git config --global pull.rebase false
        
    - name: Install jq for JSON parsing
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        
    - name: Determine upstream repository
      id: get-upstream
      env:
        INPUT_REPO: ${{ inputs.upstream_repo }}
      run: |
        echo "INPUT_REPO: '$INPUT_REPO'"
        
        if [ -z "$INPUT_REPO" ]; then
          echo "è¾“å…¥ä¸ºç©ºï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸ä»“åº“..."
          
          # èŽ·å–å½“å‰ä»“åº“ä¿¡æ¯
          CURRENT_REPO="${{ github.repository }}"
          echo "å½“å‰ä»“åº“: $CURRENT_REPO"
          
          # ç›´æŽ¥è°ƒç”¨ GitHub API èŽ·å–ä»“åº“ä¿¡æ¯
          echo "è°ƒç”¨ GitHub API èŽ·å–ä»“åº“ä¿¡æ¯..."
          
          # ä½¿ç”¨ GITHUB_TOKEN è®¤è¯
          API_RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$CURRENT_REPO")
          
          echo "API å“åº”:"
          echo "$API_RESPONSE" | head -100
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ parent å­—æ®µï¼ˆè¡¨ç¤ºæ˜¯ fork ä»“åº“ï¼‰
          PARENT_REPO=$(echo "$API_RESPONSE" | jq -r '.parent.full_name // empty' 2>/dev/null || echo "")
          
          echo "æ£€æµ‹åˆ°çš„ä¸Šæ¸¸ä»“åº“: '$PARENT_REPO'"
          
          if [ -n "$PARENT_REPO" ] && [ "$PARENT_REPO" != "null" ]; then
            UPSTREAM_REPO="$PARENT_REPO"
            echo "âœ… æˆåŠŸæ£€æµ‹åˆ°ä¸Šæ¸¸ä»“åº“: $UPSTREAM_REPO"
            echo "upstream_repo=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
            echo "has_upstream=true" >> $GITHUB_OUTPUT
          else
            # å¯¹äºŽ OpenClash ä»“åº“ï¼Œä½¿ç”¨é»˜è®¤ä¸Šæ¸¸
            REPO_NAME=$(basename "$CURRENT_REPO")
            if [ "$REPO_NAME" == "OpenClash" ]; then
              UPSTREAM_REPO="vernesong/OpenClash"
              echo "ðŸ”§ ä½¿ç”¨ OpenClash çš„é»˜è®¤ä¸Šæ¸¸: $UPSTREAM_REPO"
              echo "upstream_repo=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
              echo "has_upstream=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ æ— æ³•è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸ä»“åº“"
              echo "has_upstream=false" >> $GITHUB_OUTPUT
            fi
          fi
        else
          # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ä»“åº“
          UPSTREAM_REPO="$INPUT_REPO"
          echo "ä½¿ç”¨æŒ‡å®šä¸Šæ¸¸: $UPSTREAM_REPO"
          echo "upstream_repo=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
          echo "has_upstream=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Debug - Show git info
      if: steps.get-upstream.outputs.has_upstream == 'true'
      run: |
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "Git é…ç½®:"
        git config --list | grep -E "user\.name|user\.email"
        echo "Git è¿œç¨‹ä»“åº“:"
        git remote -v || echo "æš‚æ— è¿œç¨‹ä»“åº“"
        echo "Git åˆ†æ”¯:"
        git branch -a || echo "æš‚æ— åˆ†æ”¯ä¿¡æ¯"
        
    - name: Sync branches from upstream
      if: steps.get-upstream.outputs.has_upstream == 'true'
      env:
        UPSTREAM_REPO: ${{ steps.get-upstream.outputs.upstream_repo }}
      run: |
        echo "å¼€å§‹åŒæ­¥ä¸Šæ¸¸ä»“åº“: $UPSTREAM_REPO"
        
        # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ï¼ˆå¦‚æžœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤å†æ·»åŠ ï¼‰
        git remote remove upstream 2>/dev/null || true
        git remote add upstream "https://github.com/$UPSTREAM_REPO.git"
        
        echo "å½“å‰è¿œç¨‹ä»“åº“:"
        git remote -v
        
        # èŽ·å–ä¸Šæ¸¸æ‰€æœ‰åˆ†æ”¯
        echo "èŽ·å–ä¸Šæ¸¸åˆ†æ”¯..."
        git fetch upstream
        
        # æ˜¾ç¤ºæ‰€æœ‰åˆ†æ”¯
        echo "æ‰€æœ‰åˆ†æ”¯åˆ—è¡¨:"
        git branch -a
        
        # èŽ·å–ä¸Šæ¸¸åˆ†æ”¯åï¼ˆæŽ’é™¤ HEADï¼‰
        BRANCHES=$(git branch -r | grep 'upstream/' | grep -v HEAD | sed 's/upstream\///')
        
        if [ -z "$BRANCHES" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°ä¸Šæ¸¸åˆ†æ”¯"
          echo "å°è¯•æ£€æŸ¥è¿œç¨‹åˆ†æ”¯..."
          git ls-remote --heads upstream
          exit 0
        fi
        
        echo "æ‰¾åˆ°çš„ä¸Šæ¸¸åˆ†æ”¯:"
        echo "$BRANCHES"
        
        # ä¿å­˜å½“å‰åˆ†æ”¯ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        ORIG_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
        echo "å½“å‰åˆ†æ”¯: $ORIG_BRANCH"
        
        # åŒæ­¥æ¯ä¸ªåˆ†æ”¯
        for BRANCH in $BRANCHES; do
          echo ""
          echo "=== å¤„ç†åˆ†æ”¯: $BRANCH ==="
          
          # æ¸…ç†åˆ†æ”¯å
          BRANCH=$(echo "$BRANCH" | xargs)
          
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
            echo "åˆ†æ”¯å·²å­˜åœ¨ï¼Œåˆ‡æ¢åˆ° $BRANCH"
            git checkout "$BRANCH"
            
            # æ‹‰å–ä¸Šæ¸¸æ›´æ–°
            echo "æ‹‰å–ä¸Šæ¸¸æ›´æ–°..."
            git fetch upstream "$BRANCH"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
            LOCAL_COMMIT=$(git rev-parse "$BRANCH")
            UPSTREAM_COMMIT=$(git rev-parse "upstream/$BRANCH")
            
            if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ]; then
              echo "âœ… åˆ†æ”¯ $BRANCH å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°"
            else
              echo "å‘çŽ°æ›´æ–°ï¼Œåˆå¹¶ä¸Šæ¸¸å˜æ›´..."
              git merge --no-edit "upstream/$BRANCH" || {
                echo "âš ï¸ åˆå¹¶å†²çªï¼Œä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬"
                git reset --hard "upstream/$BRANCH"
              }
            fi
          else
            echo "åˆ›å»ºæ–°åˆ†æ”¯: $BRANCH"
            git checkout -b "$BRANCH" "upstream/$BRANCH"
          fi
          
          # æŽ¨é€åˆ° origin
          echo "æŽ¨é€åˆ° origin..."
          if git push origin "$BRANCH"; then
            echo "âœ… åˆ†æ”¯ $BRANCH åŒæ­¥å®Œæˆ"
          else
            echo "âŒ æŽ¨é€å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æŽ¨é€..."
            git push --force origin "$BRANCH" && echo "âœ… å¼ºåˆ¶æŽ¨é€æˆåŠŸ" || echo "âŒ å¼ºåˆ¶æŽ¨é€å¤±è´¥"
          fi
        done
        
        # æ¢å¤åŽŸåˆ†æ”¯
        if [ -n "$ORIG_BRANCH" ]; then
          git checkout "$ORIG_BRANCH" 2>/dev/null || true
          echo "å·²åˆ‡æ¢å›žåˆ†æ”¯: $ORIG_BRANCH"
        fi
        
        echo ""
        echo "ðŸŽ‰ åŒæ­¥å®Œæˆ"
        
    - name: Create summary
      if: always()
      run: |
        echo "## ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if ${{ steps.get-upstream.outputs.has_upstream == 'true' }}; then
          echo "**ä»“åº“:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸:** ${{ steps.get-upstream.outputs.upstream_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "**åŒæ­¥æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if ${{ job.status == 'success' }}; then
            echo "**çŠ¶æ€:** âœ… åŒæ­¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€:** âš ï¸ åŒæ­¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºçŽ°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**çŠ¶æ€:** âŒ æ— æ³•ç¡®å®šä¸Šæ¸¸ä»“åº“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è§£å†³æ–¹æ³•:**" >> $GITHUB_STEP_SUMMARY
          echo "1. æ‰‹åŠ¨æŒ‡å®šä¸Šæ¸¸ä»“åº“ï¼Œæ ¼å¼ä¸º `owner/repo`" >> $GITHUB_STEP_SUMMARY
          echo "2. æ£€æŸ¥ä»“åº“æ˜¯å¦ä¸º fork ä»“åº“" >> $GITHUB_STEP_SUMMARY
          echo "3. ç¡®è®¤ GitHub Token æœ‰è¶³å¤Ÿçš„æƒé™è®¿é—®ä»“åº“ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        fi
